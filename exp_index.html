<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Educational Topics Explorer - Learning Hub</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Google Fonts (Montserrat) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
  <!-- Font Awesome for video player icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- الموقع الأصلي – أنماط الصفحة العامة -->
  <style>
    /* Reset and basic body styling */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #fafafa; /* نفس الخلفية */
      color: #2c3e50; /* نفس لون الخط */
    }
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
    }
    /* Header with full background image, cover style, slight overlay and blur */
    .header {
      position: relative;
      min-height: 300px;
      padding: 150px 0; 
      background: url("https://raw.githubusercontent.com/hhkuy/Sums_Q_Pic/main/pic/6dd421aa56.jpg") no-repeat center center / cover;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #fff;
      overflow: hidden;
    }
    .header::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(3px);
      z-index: 1;
    }
    .header > div {
      position: relative;
      z-index: 2;
      margin: 0 20px;
    }
    .header h1 {
      margin: 0;
      font-size: 2.5rem;
      color: #fff;
    }
    .header p {
      margin-top: 10px;
      font-size: 1.2rem;
      color: #f2f2f2;
    }
    /* Main container styling */
    .container {
      margin-top: 20px;
      max-width: 900px;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #2e4053;
    }
    p.welcome {
      text-align: center;
      font-size: 1.1em;
      margin-bottom: 30px;
      color: #2874a6;
    }
    /* Topics search container */
    #topicsSearchContainer {
      margin: 20px auto;
      max-width: 900px;
      display: block;
    }
    #topicSearch {
      border-radius: 30px;
      padding: 12px 20px;
      font-size: 1em;
      box-shadow: none;
      border: 1px solid #ccc;
      transition: border 0.2s ease;
    }
    #topicSearch:focus {
      outline: none;
      border-color: #007bff;
    }
    /* Accordion styles */
    .accordion-button {
      font-weight: 600;
      color: #555;
      background-color: #fafafa;
      border: none;
      outline: none;
      transition: background-color 0.3s, color 0.3s;
    }
    .accordion-button:not(.collapsed) {
      background-color: #e9ecef;
      color: #2c3e50;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.125);
    }
    .accordion-item {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }
    .accordion-item .accordion-body {
      background-color: #fff;
    }
    .btn-show-content {
      margin-top: 10px;
    }
    /* Custom button styling */
    .btn-custom {
      border-radius: 50px;
      padding: 12px 20px;
      font-size: 1.1em;
      transition: all 0.3s ease;
    }
    .btn-custom:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,123,255,0.2);
    }
    /* Content display area */
    #result {
      margin-top: 30px;
      background-color: #fff;
      padding: 20px;
      border-radius: 15px;
      border: 1px solid #ddd;
      min-height: 200px;
      font-size: 14px;
    }
    #result h1 { color: #2e4053; }
    #result h2 { color: #2874a6; }
    #result h3 { color: #148f77; }
    #result h4 { color: #9b59b6; }
    #result h5, #result h6 { color: #b03a2e; }
    #result p, #result li, #result td, #result th { color: #2c3e50; }
    #result strong { color: #6c3483; font-weight: bold; }
    #result em { color: #d35400; font-style: italic; }
    #result pre,
    #result code {
      background: #e8f0fe;
      padding: 4px 8px;
      border-radius: 4px;
      color: #34495e;
    }
    #result table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    #result table th, #result table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    #result table thead { background-color: #f2f2f2; }
    /* حل مشكلة خروج الجداول عن الحدود على الشاشات الصغيرة */
    @media (max-width: 576px) {
      #result table {
        display: block;
        overflow-x: auto;
      }
    }

    /* Floating navigation */
    .floating-buttons {
      position: fixed;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
    }
    .floating-buttons button {
      border-radius: 50px;
      padding: 10px 15px;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    .floating-buttons button:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,123,255,0.2);
    }

    /* ألوان خاصة للتريغرز (أسئلة/صور/فيديو/رابط/متعدّد/iframe) */
    .question-trigger {
      color: #ff8c00;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .image-trigger {
      color: #28a745;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .video-trigger {
      color: #007bff;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .link-trigger {
      color: #6f42c1;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .multi-trigger {
      color: #dc3545;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .iframe-trigger {
      color: #6c757d;
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }

    /* Question modal items */
    .question-item {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .answer-result {
      margin-top: 10px;
    }
    /* Content Search Modal */
    .modal-content-search {
      border-radius: 15px;
    }
    .search-result-item {
      padding: 5px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
    .search-result-item:hover {
      background-color: #f2f2f2;
    }

    /*
      العلامة المائية ثابتة في وسط الشاشة أثناء التمرير:
      نستخدم position: fixed كي لا تتحرك مع المحتوى.
    */
    #pageContent {
      position: relative;
    }
    #pageContent::before {
      content: "SUMS Site\\A https://sites.google.com/view/medsums/sums-questions-bank-sqb";
      white-space: pre;
      position: fixed; /* تبقى ثابتة عند التمرير */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 25px;
      color: rgba(0, 0, 0, 0.07);
      pointer-events: none;
      z-index: 9998;
      text-align: center;
    }

    /* Media queries */
    @media (max-width: 576px) {
      .header {
        padding: 100px 0;
      }
      .header h1 {
        font-size: 1.8rem;
      }
      .header p {
        font-size: 1rem;
      }
      .btn-show-content {
        width: 100%;
        margin-top: 15px;
      }
      .row .col {
        margin-bottom: 10px;
      }
    }
  </style>
  
  <!-- أنماط مشغل الفيديو المتقدم -->
  <style>
    /* أنماط مشغل الفيديو المتقدم */
    #videoContainer {
      position: relative;
      width: 800px;
      max-width: 90%;
      background-color: #000;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      border-radius: 8px;
      overflow: hidden;
      touch-action: none;
    }
    #videoWrapper {
      position: relative;
      width: 100%;
      overflow: hidden;
      touch-action: none;
      transform: translate(0px, 0px) scale(1);
      transition: transform 0.1s;
    }
    #videoPlayer {
      width: 100%;
      display: block;
      user-select: none;
      -webkit-user-drag: none;
    }
    #playPauseOverlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 60px;
      color: rgba(255,255,255,0.8);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      text-shadow: 0 0 10px rgba(0,0,0,0.5);
      cursor: pointer;
      z-index: 2;
    }
    #customControls {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: rgba(0, 0, 0, 0.7);
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 10px;
      opacity: 1;
      transition: opacity 0.3s ease-in-out;
      z-index: 2;
    }
    #customControls.hiddenControls {
      opacity: 0;
      pointer-events: none;
    }
    #timeDisplay {
      text-align: center;
      font-size: 14px;
    }
    #progressWrapper {
      position: relative;
      width: 100%;
    }
    #progressContainer {
      position: relative;
      width: 100%;
      height: 8px;
      background: #444;
      border-radius: 4px;
      cursor: pointer;
    }
    #bufferedBar {
      position: absolute;
      left: 0;
      height: 100%;
      background: rgba(255,255,255,0.5);
      width: 0%;
      border-radius: 4px;
      z-index: 3;
    }
    #progressBar {
      position: absolute;
      left: 0;
      height: 100%;
      background: #f39c12;
      width: 0%;
      border-radius: 4px;
      z-index: 4;
    }
    #dragHandle {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 16px;
      height: 16px;
      background: #f39c12;
      border: 2px solid #fff;
      border-radius: 50%;
      cursor: pointer;
      z-index: 5;
      transition: left 0.1s ease-out;
    }
    #previewTooltip {
      position: absolute;
      bottom: 15px;
      left: 0;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 4px 6px;
      border-radius: 4px;
      display: none;
      font-size: 12px;
      pointer-events: none;
    }
    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .control-group {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    button, input[type="range"] {
      background: transparent;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      outline: none;
    }
    button:hover {
      color: #f39c12;
    }
    #volumeControl {
      width: 100px;
    }
    #speedOptions {
      position: absolute;
      bottom: 50px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      border: 1px solid #fff;
      border-radius: 4px;
      display: none;
      flex-direction: column;
      z-index: 3;
    }
    #speedOptions button {
      padding: 5px 10px;
      font-size: 14px;
      text-align: left;
    }
    #speedOptions button:hover {
      background: #f39c12;
    }
  </style>

  <!-- إضافة دعم MathJax لعرض الرموز والمعادلات الرياضية بشكل صحيح -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <!-- استدعاء مكتبة MathJax -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

</head>
<body>

  <!-- Navbar identical to index.html -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">SUMS</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" 
              aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-link" href="index.html">SQB Hub</a>
          <a class="nav-link active" aria-current="page" href="exp_index.html">Learning Hub</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Header with slight blur effect -->
  <header class="header">
    <div>
      <h1>Welcome to Educational Topics Explorer</h1>
      <p>Explore our topics and learn interactively</p>
    </div>
  </header>

  <!-- Topics Search Box (visible on Topics page) -->
  <div class="container" id="topicsSearchContainer">
    <input type="search" id="topicSearch" class="form-control mb-3" placeholder="Search topics, subtopics, etc. (min 1 letter)">
  </div>

  <!-- Topics Page -->
  <div class="container" id="pageTopics">
    <h1><i class="bi bi-journal-text"></i> Educational Topics Explorer</h1>
    <p class="welcome">
      Welcome! Explore various topics below. Use the search box above for partial or full matches. 
      Click on highlighted phrases in the content to take interactive tests.
    </p>
    <div class="accordion" id="topicsAccordion">
      <!-- Accordion items will be built dynamically from exp_topics.json -->
    </div>
  </div>

  <!-- Content Page -->
  <div class="container" id="pageContent" style="display: none;">
    <!-- Top row: Back and Download PDF buttons side by side -->
    <div class="row mb-3">
      <div class="col">
        <button class="btn btn-secondary btn-custom w-100" onclick="goBackToTopics()">
          <i class="bi bi-arrow-left-circle-fill"></i> Back to Topics
        </button>
      </div>
      <div class="col">
        <button class="btn btn-info btn-custom w-100" onclick="downloadPdf()">
          <i class="bi bi-download"></i> Download PDF
        </button>
      </div>
    </div>
    <!-- The full hierarchical topic path is displayed in contentTitle -->
    <h1 id="contentTitle"><i class="bi bi-file-earmark-text-fill"></i> Topic Content</h1>
    <div id="result"></div>
    <!-- Bottom Back button -->
    <div class="text-center mt-4">
      <button class="btn btn-secondary btn-custom" onclick="goBackToTopics()">
        <i class="bi bi-arrow-left-circle-fill"></i> Back to Topics
      </button>
    </div>
  </div>

  <!-- Floating Navigation and Content Search Button (visible only on Content page) -->
  <div class="floating-buttons" id="floatingButtons">
    <button class="btn btn-success" onclick="scrollToTop()" title="Scroll to Top">
      <i class="bi bi-arrow-up"></i>
    </button>
    <button class="btn btn-success" onclick="scrollToBottom()" title="Scroll to Bottom">
      <i class="bi bi-arrow-down"></i>
    </button>
    <button class="btn btn-primary" onclick="openContentSearchModal()" title="Search Content">
      <i class="bi bi-search"></i>
    </button>
  </div>

  <!-- Content Search Modal -->
  <div class="modal fade" id="contentSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content modal-content-search">
        <div class="modal-header">
          <h5 class="modal-title">Search Within Content</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="search" id="contentSearchInput" class="form-control" placeholder="Type at least one letter to search..." />
          <div id="contentSearchResults" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Questions Modal -->
  <div class="modal fade" id="questionsModal" tabindex="-1" aria-labelledby="questionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="questionsModalLabel">Questions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="questionsModalBody">
          <!-- Test-like questions will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- نافذة منبثقة لعرض الصور أو الفيديو أو الروابط أو iframes -->
  <div class="modal fade" id="multiTriggerModal" tabindex="-1" aria-labelledby="multiTriggerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="multiTriggerModalLabel">Resources</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="multiTriggerModalBody">
          <!-- سيتم تعبئة هذه المساحة بمحتوى الصور أو الفيديو أو الروابط أو iframes -->
        </div>
      </div>
    </div>
  </div>

  <!-- قالب مشغل الفيديو المتقدم (لن يظهر حتى يتم استدعاؤه) -->
  <template id="advancedVideoTemplate">
    <div id="videoContainer">
      <div id="videoWrapper">
        <video id="videoPlayer" preload="metadata" controlsList="nodownload noremoteplayback" disablePictureInPicture>
          <source src="https://example.com/video.mp4" type="video/mp4">
          متصفحك لا يدعم الفيديو.
        </video>
        <div id="playPauseOverlay"><i class="fas fa-play"></i></div>
      </div>
      <div id="customControls">
        <div id="timeDisplay">00:00 / 00:00</div>
        <div id="progressWrapper">
          <div id="progressContainer">
            <div id="bufferedBar"></div>
            <div id="progressBar"></div>
            <div id="dragHandle"></div>
          </div>
          <div id="previewTooltip">
            <div id="previewTime">00:00</div>
          </div>
        </div>
        <div class="control-row">
          <div class="control-group">
            <button id="toggleBtn" title="تشغيل/إيقاف"><i class="fas fa-play"></i></button>
            <button id="speedBtn" title="سرعة التشغيل">سرعة</button>
            <div id="speedOptions">
              <button data-speed="0.5">0.5x</button>
              <button data-speed="0.75">0.75x</button>
              <button data-speed="1">1x</button>
              <button data-speed="1.25">1.25x</button>
              <button data-speed="1.5">1.5x</button>
              <button data-speed="2">2x</button>
            </div>
          </div>
          <div class="control-group">
            <i class="fas fa-volume-up" title="الصوت"></i>
            <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1">
            <button id="fullscreenBtn" title="ملء الشاشة"><i class="fas fa-expand"></i></button>
            <button id="resetBtn" title="إعادة الوضع الطبيعي"><i class="fas fa-undo"></i></button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  
  <!-- الأكواد الرئيسية للموقع (exp_main.js) -->
  <script src="exp_main.js"></script>
  
  <!-- أكواد التعامل مع مشغل الفيديو + الكود الخاص بالطباعة -->
  <script>
    // -------------------------------------------
    // مشغل الفيديو المتقدم
    // -------------------------------------------
    function initAdvancedVideoPlayers() {
      const containers = document.querySelectorAll('.video-container');
      containers.forEach(container => {
        const originalVideo = container.querySelector('video');
        if(originalVideo) {
          const videoSrc = originalVideo.getAttribute('src');
          const template = document.getElementById('advancedVideoTemplate');
          const clone = template.content.cloneNode(true);
          const videoElem = clone.querySelector('#videoPlayer');
          const sourceElem = videoElem.querySelector('source');
          sourceElem.setAttribute('src', videoSrc);
          videoElem.removeAttribute('controls');
          container.innerHTML = '';
          container.appendChild(clone);
          initAdvancedVideoPlayerEvents(container);
        }
      });
    }

    function initAdvancedVideoPlayerEvents(container) {
      const videoContainer = container.querySelector('#videoContainer');
      const videoWrapper = container.querySelector('#videoWrapper');
      const video = container.querySelector('#videoPlayer');
      const customControls = container.querySelector('#customControls');
      const toggleBtn = container.querySelector('#toggleBtn');
      const speedBtn = container.querySelector('#speedBtn');
      const speedOptions = container.querySelector('#speedOptions');
      const volumeControl = container.querySelector('#volumeControl');
      const fullscreenBtn = container.querySelector('#fullscreenBtn');
      const resetBtn = container.querySelector('#resetBtn');
      const timeDisplay = container.querySelector('#timeDisplay');
      const progressContainer = container.querySelector('#progressContainer');
      const bufferedBar = container.querySelector('#bufferedBar');
      const progressBar = container.querySelector('#progressBar');
      const dragHandle = container.querySelector('#dragHandle');
      const playPauseOverlay = container.querySelector('#playPauseOverlay');
      
      let controlsTimeout;
      let isDragging = false;
      let currentScale = 1;
      let currentTranslate = { x: 0, y: 0 };
      let lastPanPosition = null;
      let initialDistance = null;
      let initialScale = 1;

      video.removeAttribute('controls');

      function togglePlayPause() {
        video[video.paused ? 'play' : 'pause']();
      }
      function updatePlayPauseIcon() {
        const icon = video.paused ? 'play' : 'pause';
        toggleBtn.innerHTML = `<i class="fas fa-${icon}"></i>`;
        playPauseOverlay.innerHTML = `<i class="fas fa-${icon}"></i>`;
      }
      video.addEventListener('click', togglePlayPause);
      playPauseOverlay.addEventListener('click', togglePlayPause);
      toggleBtn.addEventListener('click', togglePlayPause);
      video.addEventListener('play', () => { updatePlayPauseIcon(); playPauseOverlay.style.opacity = '0'; });
      video.addEventListener('pause', () => { updatePlayPauseIcon(); playPauseOverlay.style.opacity = '1'; });

      function showControls() {
        customControls.classList.remove('hiddenControls');
        resetControlsTimer();
      }
      function resetControlsTimer() {
        clearTimeout(controlsTimeout);
        if (!video.paused) {
          controlsTimeout = setTimeout(() => {
            customControls.classList.add('hiddenControls');
          }, 3000);
        }
      }
      videoContainer.addEventListener('mousemove', showControls);
      videoContainer.addEventListener('touchstart', showControls);
      videoContainer.addEventListener('click', () => {
        if (!customControls.classList.contains('hiddenControls')) {
          resetControlsTimer();
        }
      });
      customControls.addEventListener('mouseenter', () => clearTimeout(controlsTimeout));
      customControls.addEventListener('mouseleave', resetControlsTimer);

      speedBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        speedOptions.style.display = speedOptions.style.display === 'flex' ? 'none' : 'flex';
      });
      document.addEventListener('click', (e) => {
        if (!e.target.closest('#speedOptions') && !e.target.matches('#speedBtn')) {
          speedOptions.style.display = 'none';
        }
      });
      speedOptions.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          const speed = parseFloat(btn.dataset.speed);
          video.playbackRate = speed;
          speedBtn.textContent = `${speed}x`;
        });
      });

      volumeControl.addEventListener('input', () => {
        video.volume = volumeControl.value;
      });
      fullscreenBtn.addEventListener('click', () => {
        if (!document.fullscreenElement) {
          videoContainer.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      });
      resetBtn.addEventListener('click', () => {
        currentScale = 1;
        currentTranslate = { x: 0, y: 0 };
        updateTransform();
      });

      function updateProgress() {
        const playedPercent = (video.currentTime / video.duration) * 100;
        progressBar.style.width = `${playedPercent}%`;
        dragHandle.style.left = `${playedPercent}%`;
        timeDisplay.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
        if (video.buffered.length) {
          const bufferedEnd = video.buffered.end(video.buffered.length - 1);
          const bufferedPercent = (bufferedEnd / video.duration) * 100;
          if (bufferedPercent > playedPercent) {
            bufferedBar.style.left = `${playedPercent}%`;
            bufferedBar.style.width = `${bufferedPercent - playedPercent}%`;
          } else {
            bufferedBar.style.width = '0%';
          }
        }
      }
      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      }
      video.addEventListener('timeupdate', updateProgress);
      video.addEventListener('loadedmetadata', updateProgress);
      video.addEventListener('progress', updateProgress);

      progressContainer.addEventListener('mousedown', startDrag);
      progressContainer.addEventListener('touchstart', startDrag, { passive: false });
      function startDrag(e) {
        isDragging = true;
        dragHandle.style.transition = 'none';
        handleDrag(e);
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', stopDrag);
        document.addEventListener('touchmove', handleDrag, { passive: false });
        document.addEventListener('touchend', stopDrag);
      }
      function handleDrag(e) {
        if (!isDragging) return;
        const rect = progressContainer.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        if (!clientX) return;
        const x = Math.min(Math.max(clientX - rect.left, 0), rect.width);
        const percent = x / rect.width;
        video.currentTime = percent * video.duration;
        updateProgress();
      }
      function stopDrag() {
        isDragging = false;
        dragHandle.style.transition = 'left 0.1s ease-out';
        document.removeEventListener('mousemove', handleDrag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', handleDrag);
        document.removeEventListener('touchend', stopDrag);
      }

      videoWrapper.addEventListener('touchstart', handleTouchStart, { passive: false });
      videoWrapper.addEventListener('touchmove', handleTouchMove, { passive: false });
      videoWrapper.addEventListener('touchend', handleTouchEnd);
      function handleTouchStart(e) {
        if (e.touches.length === 2) {
          initialDistance = getDistance(e.touches[0], e.touches[1]);
          initialScale = currentScale;
        } else if (e.touches.length === 1 && currentScale > 1) {
          lastPanPosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
      }
      function handleTouchMove(e) {
        if (e.touches.length === 2 && initialDistance !== null) {
          const newDistance = getDistance(e.touches[0], e.touches[1]);
          let newScale = initialScale * (newDistance / initialDistance);
          newScale = Math.min(Math.max(newScale, 1), 3);
          currentScale = newScale;
          constrainTranslation();
          updateTransform();
        } else if (e.touches.length === 1 && currentScale > 1 && lastPanPosition) {
          const currentTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
          const deltaX = currentTouch.x - lastPanPosition.x;
          const deltaY = currentTouch.y - lastPanPosition.y;
          currentTranslate.x += deltaX;
          currentTranslate.y += deltaY;
          constrainTranslation();
          updateTransform();
          lastPanPosition = currentTouch;
        }
        e.preventDefault();
      }
      function handleTouchEnd(e) {
        if (e.touches.length < 2) {
          initialDistance = null;
          initialScale = currentScale;
        }
        if (e.touches.length === 0) {
          lastPanPosition = null;
        }
      }
      function getDistance(touch1, touch2) {
        return Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
      }
      function updateTransform() {
        videoWrapper.style.transform = `translate(${currentTranslate.x}px, ${currentTranslate.y}px) scale(${currentScale})`;
      }
      function constrainTranslation() {
        const containerRect = videoContainer.getBoundingClientRect();
        const maxTranslateX = (containerRect.width * (currentScale - 1)) / 2;
        const maxTranslateY = (containerRect.height * (currentScale - 1)) / 2;
        currentTranslate.x = Math.min(Math.max(currentTranslate.x, -maxTranslateX), maxTranslateX);
        currentTranslate.y = Math.min(Math.max(currentTranslate.y, -maxTranslateY), maxTranslateY);
      }
    }

    // -------------------------------------------
    // الدالة الخاصة بطباعة PDF (downloadPdf)
    // -------------------------------------------
    function downloadPdf() {
      const contentTitle = document.getElementById('contentTitle').textContent;
      let content = document.getElementById('result').innerHTML;

      // وظيفة بسيطة للتحقق إن كان العنصر داخل تريغر
      function isInTrigger(str) {
        // نفترض أن وجود class="...trigger" يمنع الاستبدال
        return /class\s*=\s*"[^"]*trigger[^"]*"/i.test(str);
      }

      // نعمل استبدالاً واحداً بنمط regex كبير
      const pattern = /<(?:div|video|iframe)\s+(?:[^>]*id="(?:videoContainer|videoWrapper|customControls)"[^>]*|class="video-container"[^>]*|[^>]*iframe[^>]*)>[\s\S]*?<\/(?:div|video|iframe)>|<video[^>]*>[\s\S]*?<\/video>/gi;

      const replacedContent = content.replace(pattern, match => {
        if (isInTrigger(match)) {
          return match; // لا نستبدل لو كان داخل تريغر
        }
        // وإلا نستبدل
        return `<p>If you want to watch the video or the content, you must subscribe to the site (you will find the form and subscription details on the site).<br>
                <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://sites.google.com/view/medsums/sums-questions-bank-sqb" alt="QR Code"/></p>`;
      });

      // الآن نبني صفحة about:blank دون أي كود خاص بالمشغّل
      // كي لا تظهر الأزرار بأي شكل
      const printWindow = window.open('about:blank', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <meta charset="UTF-8">
            <title>Download PDF</title>
            <style>
              @page { size: auto; margin: 0; }
              body {
                margin: 0; 
                padding: 0;
                font-family: 'Montserrat', sans-serif; 
                background-color: #fafafa; 
                color: #2c3e50;
              }
              /* العلامة المائية في المنتصف */
              body::before {
                content: "SUMS Site\\A https://sites.google.com/view/medsums/sums-questions-bank-sqb";
                white-space: pre;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-30deg);
                font-size: 25px;
                color: rgba(0, 0, 0, 0.07);
                pointer-events: none;
                z-index: 0;
                text-align: center;
              }
              #content {
                position: relative;
                z-index: 1;
                margin: 20px;
                padding: 20px;
                font-size: 14px;
                border: none;
              }
              h1 {
                text-align: center; 
                font-weight: 600;
                margin-bottom: 20px; 
              }
              table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
              }
              table th, table td {
                border: 1px solid #ccc;
                padding: 10px;
                text-align: left;
              }
              table thead {
                background-color: #f2f2f2;
              }
              p, li, td, th, code, pre, span {
                color: #2c3e50 !important;
              }
              .mjx-container {
                zoom: 1.2;
              }
            </style>
          </head>
          <body>
            <div id="content">
              <h1>${contentTitle}</h1>
              ${replacedContent}
            </div>
            <!-- لا نضمّن أي كود خاص بالفيديو المتقدم -->
            <!-- MathJax فقط -->
            <script>
              window.MathJax = {
                tex: {
                  inlineMath: [['$', '$'], ['\\\\(', '\\\\)']]
                },
                svg: {
                  fontCache: 'global'
                }
              };
            <\/script>
            <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"><\/script>
            <script>
              window.onload = function() {
                window.focus();
                window.print();
              };
            <\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    // -------------------------------------------
    // العودة للمواضيع
    // -------------------------------------------
    function goBackToTopics() {
      document.getElementById('pageContent').style.display = 'none';
      document.getElementById('pageTopics').style.display = 'block';
      document.getElementById('topicsSearchContainer').style.display = 'block';
      document.getElementById('floatingButtons').style.display = 'none';
    }

    // -------------------------------------------
    // Scroll
    // -------------------------------------------
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function scrollToBottom() {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    // -------------------------------------------
    // Content Search Modal
    // -------------------------------------------
    function openContentSearchModal() {
      const searchModal = new bootstrap.Modal(document.getElementById('contentSearchModal'));
      searchModal.show();
      const input = document.getElementById('contentSearchInput');
      const resultsContainer = document.getElementById('contentSearchResults');
      input.value = '';
      resultsContainer.innerHTML = '';
      input.focus();

      // Prevent multiple event listeners
      input.removeEventListener('input', handleContentSearchInput);
      input.addEventListener('input', handleContentSearchInput);
    }

    function handleContentSearchInput() {
      const query = this.value.toLowerCase();
      const resultsContainer = document.getElementById('contentSearchResults');
      resultsContainer.innerHTML = '';
      if (!query.trim()) return;

      const searchableElements = Array.from(document.querySelectorAll(
        '#result p, #result td, #result th, #result h1, #result h2, #result h3, #result h4, #result h5, #result h6, #result li'
      ));

      searchableElements.forEach(el => {
        if (el.innerText.toLowerCase().includes(query)) {
          let snippet = el.innerText;
          if (snippet.length > 150) snippet = snippet.substring(0, 150) + '...';
          const div = document.createElement('div');
          div.classList.add('search-result-item');
          div.innerText = snippet;

          div.addEventListener('click', () => {
            const searchModal = bootstrap.Modal.getInstance(document.getElementById('contentSearchModal'));
            searchModal.hide();
            setTimeout(() => {
              el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 200);
          });
          resultsContainer.appendChild(div);
        }
      });
    }
  </script>

</body>
</html>
