<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <title>Educational Topics Explorer - Learning Hub</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Google Fonts (Montserrat) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
  <!-- Font Awesome (للأيقونات العامة إن احتجتها) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- الموقع الأصلي – أنماط الصفحة العامة -->
  <style>
    /* Reset and basic body styling */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #fafafa; /* خلفية */
      color: #2c3e50; /* لون الخط */
    }
    h1, h2, h3, h4, h5, h6 {
      font-weight: 600;
    }
    /* Header with full background image, cover style, slight overlay and blur */
    .header {
      position: relative;
      min-height: 300px;
      padding: 150px 0; 
      background: url("https://raw.githubusercontent.com/hhkuy/Sums_Q_Pic/main/pic/6dd421aa56.jpg") no-repeat center center / cover;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: #fff;
      overflow: hidden;
    }
    .header::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(3px);
      z-index: 1;
    }
    .header > div {
      position: relative;
      z-index: 2;
      margin: 0 20px;
    }
    .header h1 {
      margin: 0;
      font-size: 2.5rem;
      color: #fff;
    }
    .header p {
      margin-top: 10px;
      font-size: 1.2rem;
      color: #f2f2f2;
    }
    /* Main container styling */
    .container {
      margin-top: 20px;
      max-width: 900px;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #2e4053;
    }
    p.welcome {
      text-align: center;
      font-size: 1.1em;
      margin-bottom: 30px;
      color: #2874a6;
    }
    /* Topics search container */
    #topicsSearchContainer {
      margin: 20px auto;
      max-width: 900px;
      display: block;
    }
    #topicSearch {
      border-radius: 30px;
      padding: 12px 20px;
      font-size: 1em;
      box-shadow: none;
      border: 1px solid #ccc;
      transition: border 0.2s ease;
    }
    #topicSearch:focus {
      outline: none;
      border-color: #007bff;
    }
    /* Accordion styles */
    .accordion-button {
      font-weight: 600;
      color: #555;
      background-color: #fafafa;
      border: none;
      outline: none;
      transition: background-color 0.3s, color 0.3s;
    }
    .accordion-button:not(.collapsed) {
      background-color: #e9ecef;
      color: #2c3e50;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,0.125);
    }
    .accordion-item {
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #ddd;
      margin-bottom: 10px;
    }
    .accordion-item .accordion-body {
      background-color: #fff;
    }
    .btn-show-content {
      margin-top: 10px;
    }
    /* Custom button styling */
    .btn-custom {
      border-radius: 50px;
      padding: 12px 20px;
      font-size: 1.1em;
      transition: all 0.3s ease;
    }
    .btn-custom:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,123,255,0.2);
    }
    /* Content display area */
    #result {
      margin-top: 30px;
      background-color: #fff;
      padding: 20px;
      border-radius: 15px;
      border: 1px solid #ddd;
      min-height: 200px;
      font-size: 14px;
    }
    #result h1 { color: #2e4053; }
    #result h2 { color: #2874a6; }
    #result h3 { color: #148f77; }
    #result h4 { color: #9b59b6; }
    #result h5, #result h6 { color: #b03a2e; }
    #result p, #result li, #result td, #result th { color: #2c3e50; }
    #result strong { color: #6c3483; font-weight: bold; }
    #result em { color: #d35400; font-style: italic; }
    #result pre,
    #result code {
      background: #e8f0fe;
      padding: 4px 8px;
      border-radius: 4px;
      color: #34495e;
    }
    #result table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    #result table th, #result table td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: left;
    }
    #result table thead { background-color: #f2f2f2; }
    /* حل مشكلة خروج الجداول عن الحدود على الشاشات الصغيرة */
    @media (max-width: 576px) {
      #result table {
        display: block;
        overflow-x: auto;
      }
    }

    /* Floating navigation */
    .floating-buttons {
      position: fixed;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      display: none;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
    }
    .floating-buttons button {
      border-radius: 50px;
      padding: 10px 15px;
      font-size: 1em;
      transition: all 0.3s ease;
    }
    .floating-buttons button:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,123,255,0.2);
    }

    /* ألوان خاصة للتريغرز بأنواعها: أسئلة/صور/فيديو/رابط/متعدّد/ iframe / نص */
    .question-trigger {
      color: #ff8c00; /* برتقالي */
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .image-trigger {
      color: #28a745; /* أخضر */
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .video-trigger {
      color: #007bff; /* أزرق */
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .link-trigger {
      color: #6f42c1; /* بنفسجي */
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .multi-trigger {
      color: #dc3545; /* أحمر */
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .iframe-trigger {
      color: #20c997; /* تركوازي */
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }
    .text-trigger {
      color: #d63384; /* وردي */
      font-weight: bold;
      cursor: pointer;
      text-decoration: underline;
    }

    /* Question modal items */
    .question-item {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .answer-result {
      margin-top: 10px;
    }
    /* Content Search Modal */
    .modal-content-search {
      border-radius: 15px;
    }
    .search-result-item {
      padding: 5px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
    .search-result-item:hover {
      background-color: #f2f2f2;
    }

    /* العلامة المائية: ثابتة في منتصف الإطار (لا تتحرك عند التمرير) */
    #pageContent {
      position: relative;
      overflow: hidden; /* كي لا تخرج العلامة المائية عن الإطار */
    }
    #pageContent::before {
      content: "SUMS Site\\A https://sites.google.com/view/medsums/sums-questions-bank-sqb";
      white-space: pre;
      position: fixed; /* تم تغييرها إلى fixed لتثبيت العلامة المائية */
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 25px; /* الحجم */
      color: rgba(0, 0, 0, 0.07);
      pointer-events: none;
      z-index: 9999; /* بقاء العلامة فوق كل شيء */
      text-align: center;
    }

    /* إطار جميل للفيديو (إبقاء التصميم العام بسيط لكن جذاب) */
    .default-video-container {
      position: relative;
      width: 800px;
      max-width: 90%;
      margin: 20px auto;
      background-color: #000;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      border-radius: 8px;
      overflow: hidden;
      touch-action: none; /* لأجل التكبير والتحريك */
    }
    .default-video-container video {
      width: 100%;
      height: auto;
      outline: none;
      display: block;
    }

    @media (max-width: 576px) {
      .header {
        padding: 100px 0;
      }
      .header h1 {
        font-size: 1.8rem;
      }
      .header p {
        font-size: 1rem;
      }
      .btn-show-content {
        width: 100%;
        margin-top: 15px;
      }
      .row .col {
        margin-bottom: 10px;
      }
    }
  </style>

  <!-- إضافة دعم MathJax لعرض الرموز والمعادلات الرياضية بشكل صحيح -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <!-- استدعاء مكتبة MathJax -->
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

</head>
<body>

  <!-- Navbar identical to index.html -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">SUMS</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" 
              aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
        <div class="navbar-nav">
          <a class="nav-link" href="index.html">SQB Hub</a>
          <a class="nav-link active" aria-current="page" href="exp_index.html">Learning Hub</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Header with slight blur effect -->
  <header class="header">
    <div>
      <h1>Welcome to Educational Topics Explorer</h1>
      <p>Explore our topics and learn interactively</p>
    </div>
  </header>

  <!-- Topics Search Box (visible on Topics page) -->
  <div class="container" id="topicsSearchContainer">
    <input type="search" id="topicSearch" class="form-control mb-3" placeholder="Search topics, subtopics, etc. (min 1 letter)">
  </div>

  <!-- Topics Page -->
  <div class="container" id="pageTopics">
    <h1><i class="bi bi-journal-text"></i> Educational Topics Explorer</h1>
    <p class="welcome">
      Welcome! Explore various topics below. Use the search box above for partial or full matches. 
      Click on highlighted phrases in the content to take interactive tests.
    </p>
    <div class="accordion" id="topicsAccordion">
      <!-- Accordion items will be built dynamically from exp_topics.json -->
    </div>
  </div>

  <!-- Content Page -->
  <div class="container" id="pageContent" style="display: none;">
    <!-- Top row: Back and Download PDF buttons side by side -->
    <div class="row mb-3">
      <div class="col">
        <button class="btn btn-secondary btn-custom w-100" onclick="goBackToTopics()">
          <i class="bi bi-arrow-left-circle-fill"></i> Back to Topics
        </button>
      </div>
      <div class="col">
        <button class="btn btn-info btn-custom w-100" onclick="downloadPdf()">
          <i class="bi bi-download"></i> Download PDF
        </button>
      </div>
    </div>
    <!-- The full hierarchical topic path is displayed in contentTitle -->
    <h1 id="contentTitle"><i class="bi bi-file-earmark-text-fill"></i> Topic Content</h1>
    <div id="result"></div>
    <!-- Bottom Back button -->
    <div class="text-center mt-4">
      <button class="btn btn-secondary btn-custom" onclick="goBackToTopics()">
        <i class="bi bi-arrow-left-circle-fill"></i> Back to Topics
      </button>
    </div>
  </div>

  <!-- Floating Navigation and Content Search Button (visible only on Content page) -->
  <div class="floating-buttons" id="floatingButtons">
    <button class="btn btn-success" onclick="scrollToTop()" title="Scroll to Top">
      <i class="bi bi-arrow-up"></i>
    </button>
    <button class="btn btn-success" onclick="scrollToBottom()" title="Scroll to Bottom">
      <i class="bi bi-arrow-down"></i>
    </button>
    <button class="btn btn-primary" onclick="openContentSearchModal()" title="Search Content">
      <i class="bi bi-search"></i>
    </button>
  </div>

  <!-- Content Search Modal -->
  <div class="modal fade" id="contentSearchModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content modal-content-search">
        <div class="modal-header">
          <h5 class="modal-title">Search Within Content</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="search" id="contentSearchInput" class="form-control" placeholder="Type at least one letter to search..." />
          <div id="contentSearchResults" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Questions Modal -->
  <div class="modal fade" id="questionsModal" tabindex="-1" aria-labelledby="questionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="questionsModalLabel">Questions</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="questionsModalBody">
          <!-- Test-like questions will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- نافذة منبثقة لعرض الصور أو الفيديو أو الروابط أو النصوص أو iframes (المزايا الجديدة) -->
  <div class="modal fade" id="multiTriggerModal" tabindex="-1" aria-labelledby="multiTriggerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="multiTriggerModalLabel">Resources</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="multiTriggerModalBody">
          <!-- سيتم تعبئة هذه المساحة بمحتوى الصور أو الفيديوهات أو الروابط أو النصوص أو الـ iframe وغيرها -->
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  
  <!-- الأكواد الرئيسية للموقع (exp_main.js) سيتم تحميلها منفصلة -->
  <script src="exp_main.js"></script>

  <script>
    /*==============================
      Global Variables
    ================================*/
    let questionFiles = [];         // Will store question file paths from data/topics.json
    let allSearchableElements = []; // For content search results
    let globalTopicsData = null;    // For storing the full topics array from exp_topics.json

    /*==============================
      Initialization on DOMContentLoaded
    ================================*/
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await loadQuestionFilesFromTopics();
        await loadTopicsAccordion();
      } catch (error) {
        console.error('Error during page load:', error);
      }
      // Attach topic search event listener
      document.getElementById('topicSearch').addEventListener('input', filterTopics);
    });

    /*==============================
      Load Question File Paths from data/topics.json
    ================================*/
    async function loadQuestionFilesFromTopics() {
      try {
        const res = await fetch('data/topics.json');
        if (!res.ok) throw new Error('Cannot fetch data/topics.json');
        const topicsData = await res.json();
        let allFiles = [];
        topicsData.forEach(topicObj => {
          if (Array.isArray(topicObj.subTopics)) {
            topicObj.subTopics.forEach(sub => {
              if (sub.file) {
                allFiles.push(sub.file);
              }
            });
          }
        });
        questionFiles = [...new Set(allFiles)];
        console.log('Collected question files:', questionFiles);
      } catch (err) {
        console.error('Error in loadQuestionFilesFromTopics:', err);
        alert('Failed to load question files from topics.json');
      }
    }

    /*==============================
      Load Topics Accordion from exp_data/exp_topics.json
    ================================*/
    async function loadTopicsAccordion() {
      const TOPICS_JSON_PATH = 'exp_data/exp_topics.json';
      const topicsAccordion = document.getElementById('topicsAccordion');
      try {
        const response = await fetch(TOPICS_JSON_PATH);
        if (!response.ok) throw new Error('Cannot fetch exp_topics.json');
        const data = await response.json();
        globalTopicsData = data.topics || []; // Store topics
        buildAccordion(globalTopicsData, topicsAccordion, 'main', "");
      } catch (error) {
        console.error('Error fetching topics:', error);
        topicsAccordion.innerHTML = '<p class="text-danger">Error loading topics. Ensure your local server is running.</p>';
      }
    }

    /*==============================
      Build Accordion Recursively with Hierarchical Path
    ================================*/
    function buildAccordion(topicsArray, parentElement, parentId, currentPath) {
      if (!Array.isArray(topicsArray)) return;
      topicsArray.forEach((topic, index) => {
        const uniqueId = `${parentId}-topic-${index}`;
        const headerId = `heading-${uniqueId}`;
        const collapseId = `collapse-${uniqueId}`;
        let fullPath = currentPath ? currentPath + " - " + topic.title : topic.title;

        const accordionItem = document.createElement('div');
        accordionItem.classList.add('accordion-item');
        accordionItem.innerHTML = 
          `<h2 class="accordion-header" id="${headerId}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
              data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
              <i class="bi bi-bookmarks-fill me-2"></i> ${topic.title}
            </button>
          </h2>
          <div id="${collapseId}" class="accordion-collapse collapse"
               aria-labelledby="${headerId}"
               data-bs-parent="${parentId !== 'main' ? '#' + parentId : '#topicsAccordion'}">
            <div class="accordion-body" id="body-${uniqueId}">
            </div>
          </div>`;
        parentElement.appendChild(accordionItem);

        const bodyElement = accordionItem.querySelector(`#body-${uniqueId}`);
        if (Array.isArray(topic.subtopics) && topic.subtopics.length > 0) {
          const nestedAccordion = document.createElement('div');
          nestedAccordion.classList.add('accordion');
          nestedAccordion.id = `nested-${uniqueId}`;
          bodyElement.appendChild(nestedAccordion);
          buildAccordion(topic.subtopics, nestedAccordion, `nested-${uniqueId}`, fullPath);
        }

        if (topic.dataFile) {
          const showContentBtn = document.createElement('button');
          showContentBtn.classList.add('btn', 'btn-primary', 'btn-custom', 'btn-show-content');
          showContentBtn.innerHTML = `<i class="bi bi-eye-fill"></i> View Content`;
          showContentBtn.addEventListener('click', () => {
            openContentPage(fullPath, topic.dataFile);
          });
          bodyElement.appendChild(showContentBtn);
        }
      });
    }

    /*==============================
      Filter Topics (Search in main/sub/sub-sub ... titles)
    ================================*/
    function filterTopics() {
      const query = document.getElementById('topicSearch').value.trim().toLowerCase();
      const accordion = document.getElementById('topicsAccordion');
      accordion.innerHTML = ''; // clear old results

      if (!query) {
        buildAccordion(globalTopicsData, accordion, 'main', "");
        return;
      }

      const filtered = searchTopicsRecursive(globalTopicsData, query);
      buildAccordion(filtered, accordion, 'main', "");
    }

    /*==============================
      Recursive deep search in topics
    ================================*/
    function searchTopicsRecursive(topics, query) {
      let result = [];
      if (!topics) return result;

      topics.forEach(topic => {
        const titleMatch = topic.title.toLowerCase().includes(query);
        let matchedSubtopics = [];

        if (Array.isArray(topic.subtopics)) {
          matchedSubtopics = searchTopicsRecursive(topic.subtopics, query);
        }

        if (titleMatch) {
          result.push(topic);
        } else if (matchedSubtopics.length > 0) {
          let newTopic = Object.assign({}, topic);
          newTopic.subtopics = matchedSubtopics;
          result.push(newTopic);
        }
      });
      return result;
    }

    /*==============================
      Open Content Page: Fetch Content and Show Hierarchical Path
    ================================*/
    async function openContentPage(topicFullPath, dataFile) {
      try {
        const pageTopics = document.getElementById('pageTopics');
        const pageContent = document.getElementById('pageContent');
        const contentTitle = document.getElementById('contentTitle');
        const resultDiv = document.getElementById('result');

        const response = await fetch(`exp_data/${dataFile}`);
        if (!response.ok) throw new Error(`Cannot fetch file: ${dataFile}`);
        const jsonData = await response.json();

        contentTitle.textContent = topicFullPath;
        resultDiv.innerHTML = jsonData.content ? jsonData.content : '<p>No content available.</p>';

        // إرفاق التريغرز لكل الأنواع
        attachAllTriggers();

        allSearchableElements = Array.from(document.querySelectorAll('#result p, #result td, #result th, #result h1, #result h2, #result h3, #result h4, #result h5, #result h6, #result li'));

        pageTopics.style.display = 'none';
        document.getElementById('topicsSearchContainer').style.display = 'none';
        pageContent.style.display = 'block';
        document.getElementById('floatingButtons').style.display = 'flex';

        scrollToTop();

        // تهيئة الفيديوهات الافتراضية إن وُجدت في المحتوى (نعطيها إطار جميل + منع التحميل + تكبير وتحريك باللمس)
        initDefaultVideos();
      } catch (error) {
        console.error('Error opening content file:', error);
        alert('Error loading content. Check console for details.');
      }
    }

    /*==============================
      تهيئة أي عنصر فيديو افتراضي في #result
      - لفّ الفيديو بعنصر .default-video-container
      - استخدام controlsList="nodownload" لحجب زر التنزيل
      - إضافة ميزة التكبير والتحريك باللمس
    ================================*/
    function initDefaultVideos() {
      const videos = document.querySelectorAll('#result video');
      videos.forEach(video => {
        // إذا كان الفيديو ضمن المودال (trigger) سنتجاهله. نريد فقط الفيديو الظاهر بالمحتوى الأساسي
        if (!video.closest('#result')) return;

        // تغليف الفيديو بحاوية ذات مظهر جميل
        const container = document.createElement('div');
        container.classList.add('default-video-container');

        // إعداد الفيديو لاستخدام المشغل الافتراضي بالكامل
        video.setAttribute('controls', '');
        video.setAttribute('playsinline', '');
        video.setAttribute('controlsList', 'nodownload'); // منع التحميل
        // (سرعة التشغيل الافتراضية إن وفرها المتصفح تظهر من القوائم القياسية)

        // انقل الفيديو داخل الحاوية
        video.parentNode.insertBefore(container, video);
        container.appendChild(video);

        // تمكين التكبير والتحريك باللمس
        initPinchZoomAndPan(container, video);
      });
    }

    /*==============================
      وظيفة بسيطة لتمكين التكبير (Pinch Zoom) والتحريك (Pan) باللمس حول الفيديو
    ================================*/
    function initPinchZoomAndPan(container, video) {
      let currentScale = 1;
      let currentTranslate = { x: 0, y: 0 };
      let lastPanPosition = null;
      let initialDistance = null;
      let initialScale = 1;

      container.addEventListener('touchstart', handleTouchStart, { passive: false });
      container.addEventListener('touchmove', handleTouchMove, { passive: false });
      container.addEventListener('touchend', handleTouchEnd);

      function handleTouchStart(e) {
        if (e.touches.length === 2) {
          initialDistance = getDistance(e.touches[0], e.touches[1]);
          initialScale = currentScale;
        } else if (e.touches.length === 1 && currentScale > 1) {
          lastPanPosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
      }

      function handleTouchMove(e) {
        if (e.touches.length === 2 && initialDistance !== null) {
          const newDistance = getDistance(e.touches[0], e.touches[1]);
          let newScale = initialScale * (newDistance / initialDistance);
          newScale = Math.min(Math.max(newScale, 1), 3); // حدود التكبير بين 1 و 3
          currentScale = newScale;
          constrainTranslation();
          updateTransform();
          e.preventDefault();
        } else if (e.touches.length === 1 && currentScale > 1 && lastPanPosition) {
          const currentTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
          const deltaX = currentTouch.x - lastPanPosition.x;
          const deltaY = currentTouch.y - lastPanPosition.y;
          currentTranslate.x += deltaX;
          currentTranslate.y += deltaY;
          constrainTranslation();
          updateTransform();
          lastPanPosition = currentTouch;
          e.preventDefault();
        }
      }

      function handleTouchEnd(e) {
        if (e.touches.length < 2) {
          initialDistance = null;
          initialScale = currentScale;
        }
        if (e.touches.length === 0) {
          lastPanPosition = null;
        }
      }

      function getDistance(touch1, touch2) {
        return Math.hypot(
          touch2.clientX - touch1.clientX,
          touch2.clientY - touch1.clientY
        );
      }

      function updateTransform() {
        video.style.transform = `translate(${currentTranslate.x}px, ${currentTranslate.y}px) scale(${currentScale})`;
      }

      function constrainTranslation() {
        const rect = container.getBoundingClientRect();
        const maxTranslateX = (rect.width * (currentScale - 1)) / 2;
        const maxTranslateY = (rect.height * (currentScale - 1)) / 2;
        currentTranslate.x = Math.min(Math.max(currentTranslate.x, -maxTranslateX), maxTranslateX);
        currentTranslate.y = Math.min(Math.max(currentTranslate.y, -maxTranslateY), maxTranslateY);
      }
    }

    /*==============================
      دالة ترفق جميع التريغرز (أسئلة/صور/فيديو/روابط/متعدّد/iframe/text)
    ================================*/
    function attachAllTriggers() {
      // الأسئلة
      attachQuestionTriggers();

      // الصور
      const imageEls = document.querySelectorAll('.image-trigger');
      imageEls.forEach(el => {
        el.addEventListener('click', () => {
          const imgSrc = el.getAttribute('data-img-src');
          openMultiTriggerModal({ images: [imgSrc] });
        });
      });

      // الفيديوهات
      const videoEls = document.querySelectorAll('.video-trigger');
      videoEls.forEach(el => {
        el.addEventListener('click', () => {
          const vidSrc = el.getAttribute('data-vid-src');
          openMultiTriggerModal({ videos: [vidSrc] });
        });
      });

      // الروابط
      const linkEls = document.querySelectorAll('.link-trigger');
      linkEls.forEach(el => {
        el.addEventListener('click', () => {
          const linkHref = el.getAttribute('data-link-href');
          openMultiTriggerModal({ links: [linkHref] });
        });
      });

      // التريغر المتعدد
      const multiEls = document.querySelectorAll('.multi-trigger');
      multiEls.forEach(el => {
        el.addEventListener('click', () => {
          let dataObj = {
            images: [],
            videos: [],
            links: [],
            questions: [],
            iframes: [],
            texts: []
          };
          if(el.hasAttribute('data-img-src')){
            dataObj.images.push(el.getAttribute('data-img-src'));
          }
          if(el.hasAttribute('data-vid-src')){
            dataObj.videos.push(el.getAttribute('data-vid-src'));
          }
          if(el.hasAttribute('data-link-href')){
            dataObj.links.push(el.getAttribute('data-link-href'));
          }
          if(el.hasAttribute('data-qids')){
            dataObj.questions = el.getAttribute('data-qids').split(',').map(x => x.trim());
          }
          if(el.hasAttribute('data-iframe-src')){
            dataObj.iframes.push(el.getAttribute('data-iframe-src'));
          }
          if(el.hasAttribute('data-text-content')){
            dataObj.texts.push(el.getAttribute('data-text-content'));
          }
          openMultiTriggerModal(dataObj);
        });
      });

      // تريغر الـ iframe
      const iframeEls = document.querySelectorAll('.iframe-trigger');
      iframeEls.forEach(el => {
        el.addEventListener('click', () => {
          const iframeSrc = el.getAttribute('data-iframe-src');
          openMultiTriggerModal({ iframes: [iframeSrc] });
        });
      });

      // تريغر النصّ
      const textEls = document.querySelectorAll('.text-trigger');
      textEls.forEach(el => {
        el.addEventListener('click', () => {
          const content = el.getAttribute('data-text-content');
          openMultiTriggerModal({ texts: [content] });
        });
      });
    }

    /*==============================
      Attach event listeners to .question-trigger elements
    ================================*/
    function attachQuestionTriggers() {
      const triggers = document.querySelectorAll('.question-trigger');
      triggers.forEach(trigger => {
        trigger.addEventListener('click', () => {
          const qids = trigger.getAttribute('data-qids');
          if (qids) {
            const idArray = qids.split(',').map(id => id.trim());
            fetchQuestionsAndShowModal(idArray);
          }
        });
      });
    }

    /*==============================
      فتح المودال الموحّد للصور/فيديو/روابط/أسئلة/iframe/نصوص
    ================================*/
    function openMultiTriggerModal(dataObj) {
      const modalBody = document.getElementById('multiTriggerModalBody');
      modalBody.innerHTML = '';

      // عرض الصور
      if(dataObj.images && dataObj.images.length > 0){
  dataObj.images.forEach(src => {
    const img = document.createElement('img');
    img.src = src;
    img.classList.add('img-fluid', 'mb-3');
    
    // تغليف الصورة بنفس تصميم الحدود والظلال
    const container = document.createElement('div');
    container.classList.add('default-video-container');
    container.appendChild(img);
    modalBody.appendChild(container);
  });
}

      // عرض الفيديوهات
      if(dataObj.videos && dataObj.videos.length > 0){
  dataObj.videos.forEach(src => {
    const vid = document.createElement('video');
    vid.src = src;
    vid.controls = true;
    vid.classList.add('w-100', 'mb-3');
    vid.setAttribute('controlsList', 'nodownload');
    
    // منع ظهور قائمة السياق عند الضغط المطول على الفيديو
    vid.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });
    
    // تغليف الفيديو لتطبيق نفس التصميم كما في الصفحة الرئيسية
    const container = document.createElement('div');
    container.classList.add('default-video-container');
    container.appendChild(vid);
    modalBody.appendChild(container);
  });
}


      // عرض الروابط
      if(dataObj.links && dataObj.links.length > 0){
        dataObj.links.forEach(linkHref => {
          const a = document.createElement('a');
          a.href = linkHref;
          a.target = '_blank';
          a.textContent = linkHref;
          a.classList.add('d-block', 'mb-3');
          modalBody.appendChild(a);
        });
      }
      // الأسئلة
      if(dataObj.questions && dataObj.questions.length > 0){
        fetchQuestionsAndAppendToMultiModal(dataObj.questions);
      }
      // عرض الـ iframes
      if(dataObj.iframes && dataObj.iframes.length > 0){
  dataObj.iframes.forEach(src => {
    const iframeEl = document.createElement('iframe');
    iframeEl.src = src;
    iframeEl.width = "100%";
    iframeEl.height = "350";
    iframeEl.allowFullscreen = true;
    iframeEl.classList.add('mb-3');
    
    // تغليف الـ iframe لتطبيق نفس التصميم
    const container = document.createElement('div');
    container.classList.add('default-video-container');
    container.appendChild(iframeEl);
    modalBody.appendChild(container);
  });
}

      // عرض النصوص
      if(dataObj.texts && dataObj.texts.length > 0){
        dataObj.texts.forEach(txt => {
          const p = document.createElement('p');
          p.textContent = txt;
          modalBody.appendChild(p);
        });
      }

      const multiModal = new bootstrap.Modal(document.getElementById('multiTriggerModal'));
      multiModal.show();
    }

    /*==============================
      جلب الأسئلة وعرضها داخل مودال الموارد
    ================================*/
    async function fetchQuestionsAndAppendToMultiModal(qids) {
      let allQuestions = [];
      try {
        for (const fileName of questionFiles) {
          try {
            const res = await fetch(fileName);
            if (res.ok) {
              const questionsInFile = await res.json();
              allQuestions = allQuestions.concat(questionsInFile);
            }
          } catch (err) {
            console.error(`Error fetching file ${fileName}:`, err);
          }
        }
        const filtered = allQuestions.filter(q => qids.includes(q.qID));
        let html = '';
        if (filtered.length > 0) {
          filtered.forEach(q => {
            html += `
              <div class="question-item" data-answer="${q.answer}">
                <h5>${q.question}</h5>
                <form>
                  ${q.options.map((option, idx) => 
                    `<div class="form-check">
                      <input class="form-check-input" type="radio" name="qID_${q.qID}" id="qID_${q.qID}_opt${idx}" value="${idx}">
                      <label class="form-check-label" for="qID_${q.qID}_opt${idx}">
                        ${option}
                      </label>
                    </div>`
                  ).join('')}
                  <button type="button" class="btn btn-sm btn-primary mt-2" 
                    onclick="checkAnswer(this, '${escapeHtml(q.explanation)}', '${escapeHtml(q.answerText)}')">
                    Check Answer
                  </button>
                  <div class="answer-result text-center" style="display: none;"></div>
                </form>
              </div>
            `;
          });
        } else {
          html = '<p>No questions available for this topic.</p>';
        }
        const modalBody = document.getElementById('multiTriggerModalBody');
        modalBody.insertAdjacentHTML('beforeend', html);
      } catch (error) {
        console.error('Error merging questions:', error);
        alert('Error loading questions. Check console for details.');
      }
    }

    /*==============================
      Fetch Questions and Show Modal (Test-like interface)
    ================================*/
    async function fetchQuestionsAndShowModal(idArray) {
      let allQuestions = [];
      try {
        for (const fileName of questionFiles) {
          try {
            const res = await fetch(fileName);
            if (res.ok) {
              const questionsInFile = await res.json();
              allQuestions = allQuestions.concat(questionsInFile);
            }
          } catch (err) {
            console.error(`Error fetching file ${fileName}:`, err);
          }
        }

        const filtered = allQuestions.filter(q => idArray.includes(q.qID));
        let questionsHtml = '';
        if (filtered.length > 0) {
          filtered.forEach(q => {
            questionsHtml += `
              <div class="question-item" data-answer="${q.answer}">
                <h5>${q.question}</h5>
                <form>
                  ${q.options.map((option, idx) => 
                    `<div class="form-check">
                      <input class="form-check-input" type="radio" name="qID_${q.qID}" id="qID_${q.qID}_opt${idx}" value="${idx}">
                      <label class="form-check-label" for="qID_${q.qID}_opt${idx}">
                        ${option}
                      </label>
                    </div>`
                  ).join('')}
                  <button type="button" class="btn btn-sm btn-primary mt-2" 
                    onclick="checkAnswer(this, '${escapeHtml(q.explanation)}', '${escapeHtml(q.answerText)}')">
                    Check Answer
                  </button>
                  <div class="answer-result text-center" style="display: none;"></div>
                </form>
              </div>
            `;
          });
        } else {
          questionsHtml = '<p>No questions available for this topic.</p>';
        }

        document.getElementById('questionsModalBody').innerHTML = questionsHtml;
        const questionsModal = new bootstrap.Modal(document.getElementById('questionsModal'));
        questionsModal.show();
      } catch (error) {
        console.error('Error merging questions:', error);
        alert('Error loading questions. Check console for details.');
      }
    }

    /*==============================
      Check Answer for a Question
    ================================*/
    function checkAnswer(btn, explanation, answerText) {
      const questionItem = btn.closest('.question-item');
      const correctIndex = parseInt(questionItem.dataset.answer, 10);
      const form = questionItem.querySelector('form');
      const selectedRadio = form.querySelector('input[type="radio"]:checked');
      const resultDiv = questionItem.querySelector('.answer-result');

      if (!selectedRadio) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<p class="text-danger">No option selected!</p>';
        return;
      }

      const userIndex = parseInt(selectedRadio.value, 10);
      if (userIndex === correctIndex) {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<p class="text-success fw-bold">Correct Answer!</p>
                               <p><strong>Explanation:</strong> ${explanation}</p>`;
      } else {
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `<p class="text-danger fw-bold">Wrong Answer!</p>
                               <p><strong>Correct Answer:</strong> ${answerText}</p>
                               <p><strong>Explanation:</strong> ${explanation}</p>`;
      }
    }

    /*==============================
      Utility: Escape HTML Characters
    ================================*/
    function escapeHtml(str) {
      return str
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /*==============================
      Download PDF Functionality
      - استبدال كل <video> أو <iframe> يظهر في المحتوى الأساسي
        بصورة + نص الاشتراك لكل فيديو/ iframe (لا بأس بالتكرار)
    ================================*/
    function downloadPdf() {
      const contentTitle = document.getElementById('contentTitle').textContent;
      let content = document.getElementById('result').innerHTML;

      // دالة تعيد الصورة + النص في كل مرة
      const replacedBlock = `
<p>If you want to watch the video or the content, you must subscribe to the site (you will find the form and subscription details on the site written in English).</p>
<p><img src="https://raw.githubusercontent.com/hhkuy/Sums_Q_Pic/main/pic/result.png" alt="Subscribe Image" style="max-width:200px;"/></p>
`;

      // استبدال أي <video>...</video>
      let modifiedContent = content.replace(/<video[^>]*>[\s\S]*?<\/video>/gi, replacedBlock);

      // استبدال أي <iframe>...</iframe>
      modifiedContent = modifiedContent.replace(/<iframe[^>]*>[\s\S]*?<\/iframe>/gi, replacedBlock);

      const printWindow = window.open('about:blank', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <meta charset="UTF-8">
            <title>Download PDF</title>
            <style>
              @page { size: auto; margin: 0; }
              body {
                margin: 0; 
                padding: 0;
                font-family: 'Montserrat', sans-serif; 
                background-color: #fafafa; 
                color: #2c3e50;
              }
              /* العلامة المائية بحجم أصغر وفي المنتصف - ثابتة وأمام المحتوى */
              body::before {
                content: "SUMS Site\\A https://sites.google.com/view/medsums/sums-questions-bank-sqb";
                white-space: pre;
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%) rotate(-30deg);
                font-size: 25px;
                color: rgba(0, 0, 0, 0.07);
                pointer-events: none;
                z-index: 9999;
                text-align: center;
              }
              #content {
                position: relative;
                z-index: 1;
                margin: 20px;
                padding: 20px;
                font-size: 14px;
                border: none;
              }
              /* نسخ ألوان العناوين والفقرات تمامًا كما في الصفحة الأصلية */
              h1 { color: #2e4053; }
              h2 { color: #2874a6; }
              h3 { color: #148f77; }
              h4 { color: #9b59b6; }
              h5, h6 { color: #b03a2e; }
              p, li, td, th { color: #2c3e50; }
              strong { color: #6c3483; font-weight: bold; }
              em { color: #d35400; font-style: italic; }

              /* نسخ أنماط التريغرز بألوانها */
              .question-trigger {
                color: #ff8c00; 
                font-weight: bold; 
                cursor: pointer; 
                text-decoration: underline;
              }
              .image-trigger {
                color: #28a745; 
                font-weight: bold; 
                cursor: pointer; 
                text-decoration: underline;
              }
              .video-trigger {
                color: #007bff; 
                font-weight: bold; 
                cursor: pointer; 
                text-decoration: underline;
              }
              .link-trigger {
                color: #6f42c1; 
                font-weight: bold; 
                cursor: pointer; 
                text-decoration: underline;
              }
              .multi-trigger {
                color: #dc3545; 
                font-weight: bold; 
                cursor: pointer; 
                text-decoration: underline;
              }
              .iframe-trigger {
                color: #20c997; 
                font-weight: bold; 
                cursor: pointer; 
                text-decoration: underline;
              }
              .text-trigger {
                color: #d63384; 
                font-weight: bold; 
                cursor: pointer; 
                text-decoration: underline;
              }

              table {
                width: 100%;
                border-collapse: collapse;
                margin: 20px 0;
              }
              table th, table td {
                border: 1px solid #ccc;
                padding: 10px;
                text-align: left;
              }
              table thead {
                background-color: #f2f2f2;
              }
              .mjx-container {
                zoom: 1.2;
              }
            </style>
          </head>
          <body>
            <div id="content">
              <h1>${contentTitle}</h1>
              ${modifiedContent}
            </div>
            <!-- إضافة سكريبت MathJax كي تظهر المعادلات بشكل صحيح في الصفحة المنبثقة -->
            <script>
              window.MathJax = {
                tex: {
                  inlineMath: [['$', '$'], ['\\\\(', '\\\\)']]
                },
                svg: {
                  fontCache: 'global'
                }
              };
            <\/script>
            <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"><\/script>
            <script>
              window.onload = function() {
                window.focus();
                window.print();
              };
            <\/script>
          </body>
        </html>
      `);
      printWindow.document.close();
    }

    /*==============================
      Return to Topics Page
    ================================*/
    function goBackToTopics() {
      document.getElementById('pageContent').style.display = 'none';
      document.getElementById('pageTopics').style.display = 'block';
      document.getElementById('topicsSearchContainer').style.display = 'block';
      document.getElementById('floatingButtons').style.display = 'none';
    }

    /*==============================
      Scroll Navigation Functions
    ================================*/
    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    function scrollToBottom() {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }

    /*==============================
      Content Search Modal Functions
    ================================*/
    function openContentSearchModal() {
      const searchModal = new bootstrap.Modal(document.getElementById('contentSearchModal'));
      searchModal.show();
      const input = document.getElementById('contentSearchInput');
      const resultsContainer = document.getElementById('contentSearchResults');
      input.value = '';
      resultsContainer.innerHTML = '';
      input.focus();

      // Prevent multiple event listeners
      input.removeEventListener('input', handleContentSearchInput);
      input.addEventListener('input', handleContentSearchInput);
    }

    function handleContentSearchInput() {
      const query = this.value.toLowerCase();
      const resultsContainer = document.getElementById('contentSearchResults');
      resultsContainer.innerHTML = '';
      if (!query.trim()) return;

      const searchableElements = Array.from(document.querySelectorAll(
        '#result p, #result td, #result th, #result h1, #result h2, #result h3, #result h4, #result h5, #result h6, #result li'
      ));

      searchableElements.forEach(el => {
        if (el.innerText.toLowerCase().includes(query)) {
          let snippet = el.innerText;
          if (snippet.length > 150) snippet = snippet.substring(0, 150) + '...';
          const div = document.createElement('div');
          div.classList.add('search-result-item');
          div.innerText = snippet;

          // On click, close modal then scroll to element
          div.addEventListener('click', () => {
            const searchModal = bootstrap.Modal.getInstance(document.getElementById('contentSearchModal'));
            searchModal.hide();
            setTimeout(() => {
              el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 200);
          });
          resultsContainer.appendChild(div);
        }
      });
    }
  </script>
</body>
</html>
