<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Custom Random Quiz</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- إعداد MathJax لدعم المعادلات الرياضية داخل \( ... \) و $$ ... $$ و \[ ... \] -->
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <!-- ربط مكتبة MathJax من CDN (نسخة 3) -->
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  
  <!-- إضافة مكتبة jsPDF من CDN لتحميل PDF (إن رغبت باستخدامها في هذه الصفحة) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    /*===================== Reset & Base Styles =====================*/
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
    }
    body {
      background: linear-gradient(135deg, #f3f4f6, #e2e8f0);
      color: #333;
      line-height: 1.6;
      padding-bottom: 50px;
    }
    h1, h2, h3, h4 {
      margin-bottom: 15px;
    }
    a {
      text-decoration: none;
      color: #007bff;
    }
    a:hover {
      color: #0056b3;
    }

    /*===================== Header / Title Section =====================*/
    .title-container {
      text-align: center;
      background-color: #007bff;
      color: #fff;
      padding: 20px;
      margin-bottom: 40px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .title-container h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    .title-container p {
      font-size: 1.1rem;
    }

    /*===================== Main Container =====================*/
    .main-container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 40px;
    }

    /*===================== Step 1: Select Topics & Subtopics =====================*/
    .step {
      margin-bottom: 40px;
    }
    .step h2 {
      font-size: 1.8rem;
      margin-bottom: 20px;
    }
    .topics-list, .subtopics-list {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .topic-item, .subtopic-item {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    .topic-item input, .subtopic-item input {
      margin-right: 8px;
    }
    .topic-item:hover, .subtopic-item:hover {
      background-color: #e9ecef;
    }

    /*===================== Step 2: Quiz Settings (Number of questions, Timer, etc.) =====================*/
    .quiz-settings {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 400px;
    }
    .quiz-settings label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
    }
    .quiz-settings input[type="number"] {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .quiz-settings select {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .quiz-settings .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .quiz-settings .checkbox-container input {
      transform: scale(1.2);
      margin-right: 8px;
      cursor: pointer;
    }

    /*===================== Step 3: Start Quiz Button =====================*/
    .btn-container {
      margin-top: 30px;
    }
    .btn {
      padding: 14px 24px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      color: #fff;
      background-color: #28a745;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #218838;
    }

    /*===================== Quiz Display =====================*/
    .quiz-section {
      display: none;
      margin-top: 40px;
    }
    .quiz-question {
      margin-bottom: 20px;
    }
    .quiz-question h3 {
      font-size: 1.4rem;
      margin-bottom: 10px;
      color: #343a40;
    }
    .quiz-options {
      margin-bottom: 10px;
    }
    .quiz-options .option {
      background-color: #f8f9fa;
      padding: 10px;
      margin: 6px 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s, box-shadow 0.3s;
      display: flex;
      align-items: center;
    }
    .quiz-options .option:hover {
      background-color: #e9ecef;
    }
    .quiz-options input[type="radio"] {
      margin-right: 8px;
      cursor: pointer;
      transform: scale(1.1);
    }

    /*===================== Timer Display =====================*/
    .timer-container {
      margin-bottom: 20px;
      font-size: 1.2rem;
      color: #d9534f;
      font-weight: 700;
    }

    /*===================== Progress Bar =====================*/
    .progress-bar-container {
      width: 100%;
      background-color: #e9ecef;
      height: 20px;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .progress-bar-fill {
      height: 100%;
      background-color: #007bff;
      width: 0%;
      transition: width 0.3s;
    }

    /*===================== Navigation Buttons (Next, Prev, Submit) =====================*/
    .quiz-nav-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    .quiz-nav-buttons button {
      padding: 10px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      color: #fff;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn-prev {
      background-color: #6c757d;
    }
    .btn-prev:hover {
      background-color: #5a6268;
    }
    .btn-next {
      background-color: #007bff;
    }
    .btn-next:hover {
      background-color: #0056b3;
    }
    .btn-submit {
      background-color: #28a745;
    }
    .btn-submit:hover {
      background-color: #218838;
    }

    /*===================== Result Section =====================*/
    .result-section {
      display: none;
      margin-top: 40px;
      text-align: center;
    }
    .result-section h2 {
      font-size: 2rem;
      margin-bottom: 20px;
    }
    .result-details {
      font-size: 1.2rem;
      margin-top: 10px;
    }
    .btn-restart {
      margin-top: 20px;
      padding: 14px 24px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      color: #fff;
      background-color: #dc3545;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .btn-restart:hover {
      background-color: #c82333;
    }

    /*===================== Back to main site link =====================*/
    .back-link {
      display: block;
      text-align: center;
      margin-top: 20px;
      font-weight: 600;
    }
  </style>
</head>
<body>

  <!-- عنوان الصفحة -->
  <div class="title-container">
    <h1>Custom Random Quiz</h1>
    <p>اختر المواضيع وعدد الأسئلة وابدأ الاختبار!</p>
  </div>

  <!-- الحاوية الرئيسية -->
  <div class="main-container">

    <!-- الخطوة الأولى: اختيار المواضيع والمواضيع الفرعية -->
    <div class="step" id="step-1">
      <h2>1) اختر المواضيع والمواضيع الفرعية</h2>
      <div id="topics-list" class="topics-list">
        <!-- سيتم تعبئة المواضيع ديناميكياً -->
      </div>
      <div id="subtopics-list" class="subtopics-list" style="margin-top: 20px;">
        <!-- سيتم تعبئة المواضيع الفرعية ديناميكياً -->
      </div>
    </div>

    <!-- الخطوة الثانية: إعدادات الاختبار -->
    <div class="step" id="step-2">
      <h2>2) إعدادات الاختبار</h2>
      <div class="quiz-settings">
        <div>
          <label for="question-count">عدد الأسئلة المطلوب (مثال: 30)</label>
          <input type="number" id="question-count" placeholder="e.g. 30" min="1">
        </div>
        <div class="checkbox-container">
          <input type="checkbox" id="randomize-questions">
          <label for="randomize-questions">اختيار الأسئلة عشوائياً</label>
        </div>
        <div>
          <label for="timer-type">المؤقت</label>
          <select id="timer-type">
            <option value="none">بدون مؤقت</option>
            <option value="total">مؤقت عام</option>
            <option value="per-question">مؤقت لكل سؤال</option>
          </select>
        </div>
        <div id="timer-input-container" style="display: none;">
          <label for="timer-value" id="timer-label"></label>
          <input type="number" id="timer-value" placeholder="بالثواني" min="1">
        </div>
      </div>
    </div>

    <!-- زر البدء -->
    <div class="btn-container" id="step-3">
      <button class="btn" id="start-quiz-btn">ابدأ الاختبار</button>
    </div>

    <!-- قسم عرض الكويز -->
    <div class="quiz-section" id="quiz-section">
      <!-- عرض المؤقت في حال تم اختياره -->
      <div class="timer-container" id="timer-container"></div>

      <!-- شريط التقدم -->
      <div class="progress-bar-container">
        <div class="progress-bar-fill" id="progress-bar-fill"></div>
      </div>

      <!-- السؤال وخياراته -->
      <div class="quiz-question" id="quiz-question-container">
        <!-- يتم توليد السؤال والخيارات ديناميكياً -->
      </div>

      <!-- أزرار التنقل (سابق - التالي - إنهاء) -->
      <div class="quiz-nav-buttons">
        <button class="btn-prev" id="prev-btn">السابق</button>
        <button class="btn-next" id="next-btn">التالي</button>
        <button class="btn-submit" id="submit-btn" style="display: none;">إنهاء الاختبار</button>
      </div>
    </div>

    <!-- قسم النتيجة النهائية -->
    <div class="result-section" id="result-section">
      <h2>نتيجتك النهائية</h2>
      <div class="result-details" id="result-details">
        <!-- يتم توليد تفاصيل النتيجة هنا -->
      </div>
      <button class="btn-restart" id="restart-btn">إعادة الاختبار</button>
    </div>

  </div>

  <!-- رابط العودة للصفحة الرئيسية أو صفحة المواضيع -->
  <a href="./index.html" class="back-link">← عودة إلى الصفحة الرئيسية</a>

  <!-- السكربت الخاص بهذه الصفحة -->
  <script>
    /*********************************************
     *         إعدادات وتهيئة عامة للصفحة        *
     *********************************************/
    const TOPICS_JSON_FILE = 'data/topics.json'; // تأكد من المسار الصحيح

    // متغيرات لتخزين بيانات المواضيع والمواضيع الفرعية
    let allTopics = [];
    let selectedTopics = new Set();
    let selectedSubtopics = new Set();

    // متغيرات الأسئلة
    let allSelectedQuestions = []; // جميع الأسئلة المختارة من المواضيع المحددة
    let currentQuestionIndex = 0;
    let userAnswers = []; // لتخزين إجابات المستخدم

    // إعدادات المؤقّت
    let timerType = 'none';
    let timerValue = 0;     // عدد الثواني (إجمالي أو لكل سؤال)
    let timeRemaining = 0;  // عدد الثواني المتبقية
    let timerInterval = null;

    // عناصـر DOM
    const topicsListEl        = document.getElementById('topics-list');
    const subtopicsListEl     = document.getElementById('subtopics-list');
    const questionCountInput  = document.getElementById('question-count');
    const randomizeQuestions  = document.getElementById('randomize-questions');
    const timerTypeSelect     = document.getElementById('timer-type');
    const timerInputContainer = document.getElementById('timer-input-container');
    const timerValueInput     = document.getElementById('timer-value');
    const timerLabel          = document.getElementById('timer-label');
    const startQuizBtn        = document.getElementById('start-quiz-btn');
    const quizSection         = document.getElementById('quiz-section');
    const timerContainer      = document.getElementById('timer-container');
    const progressBarFill     = document.getElementById('progress-bar-fill');
    const quizQuestionContainer = document.getElementById('quiz-question-container');
    const prevBtn             = document.getElementById('prev-btn');
    const nextBtn             = document.getElementById('next-btn');
    const submitBtn           = document.getElementById('submit-btn');
    const resultSection       = document.getElementById('result-section');
    const resultDetails       = document.getElementById('result-details');
    const restartBtn          = document.getElementById('restart-btn');

    /*********************************************
     *           تحميل المواضيع و عرضها          *
     *********************************************/
    document.addEventListener('DOMContentLoaded', () => {
      fetchTopics();
      setupEventListeners();
    });

    function fetchTopics() {
      fetch(TOPICS_JSON_FILE)
        .then(response => response.json())
        .then(data => {
          allTopics = data;
          displayTopics(data);
        })
        .catch(err => console.error('Error loading topics.json:', err));
    }

    function displayTopics(topicsArray) {
      topicsListEl.innerHTML = '';
      subtopicsListEl.innerHTML = '';

      topicsArray.forEach((topic, idx) => {
        // عنصر لتمثيل الموضوع (checkbox + label)
        const topicItem = document.createElement('div');
        topicItem.classList.add('topic-item');
        
        const topicCheckbox = document.createElement('input');
        topicCheckbox.type = 'checkbox';
        topicCheckbox.value = idx; // نضع رقم الفهرس كقيمـة
        topicCheckbox.addEventListener('change', handleTopicCheck);

        const topicLabel = document.createElement('label');
        topicLabel.textContent = topic.topicName;

        topicItem.appendChild(topicCheckbox);
        topicItem.appendChild(topicLabel);
        topicsListEl.appendChild(topicItem);
      });
    }

    function handleTopicCheck(e) {
      const topicIndex = parseInt(e.target.value);
      if (e.target.checked) {
        selectedTopics.add(topicIndex);
      } else {
        selectedTopics.delete(topicIndex);
      }
      displaySubtopics();
    }

    function displaySubtopics() {
      // كل مرة نعيد تفريغ حقل المواضيع الفرعية
      subtopicsListEl.innerHTML = '';
      selectedSubtopics.clear();

      // نجمع جميع المواضيع الفرعية من المواضيع المختارة
      selectedTopics.forEach(topicIndex => {
        const topic = allTopics[topicIndex];
        if (topic.subTopics && topic.subTopics.length > 0) {
          topic.subTopics.forEach((sub, subIndex) => {
            // عنصر الفرع
            const subtopicItem = document.createElement('div');
            subtopicItem.classList.add('subtopic-item');

            const subtopicCheckbox = document.createElement('input');
            subtopicCheckbox.type = 'checkbox';
            // نميّز كل فرع بمفتاح (موضوع + فرع) مثلاً
            subtopicCheckbox.value = JSON.stringify({ topicIndex, subIndex });
            subtopicCheckbox.addEventListener('change', handleSubtopicCheck);

            const subtopicLabel = document.createElement('label');
            subtopicLabel.textContent = sub.name;

            subtopicItem.appendChild(subtopicCheckbox);
            subtopicItem.appendChild(subtopicLabel);
            subtopicsListEl.appendChild(subtopicItem);
          });
        }
      });
    }

    function handleSubtopicCheck(e) {
      const { topicIndex, subIndex } = JSON.parse(e.target.value);
      if (e.target.checked) {
        selectedSubtopics.add(\`\${topicIndex}-\${subIndex}\`);
      } else {
        selectedSubtopics.delete(\`\${topicIndex}-\${subIndex}\`);
      }
    }

    /*********************************************
     *       إعداد المستمعين للأحداث (Events)     *
     *********************************************/
    function setupEventListeners() {
      // عند تغيير نوع المؤقّت
      timerTypeSelect.addEventListener('change', (e) => {
        timerType = e.target.value;
        if (timerType === 'none') {
          timerInputContainer.style.display = 'none';
        } else if (timerType === 'total') {
          timerInputContainer.style.display = 'block';
          timerLabel.textContent = 'الوقت الكلي (بالثواني)';
        } else if (timerType === 'per-question') {
          timerInputContainer.style.display = 'block';
          timerLabel.textContent = 'الوقت لكل سؤال (بالثواني)';
        }
      });

      // زر البدء
      startQuizBtn.addEventListener('click', startQuiz);

      // زر السابق
      prevBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
          currentQuestionIndex--;
          renderQuestion();
        }
      });

      // زر التالي
      nextBtn.addEventListener('click', () => {
        if (currentQuestionIndex < allSelectedQuestions.length - 1) {
          currentQuestionIndex++;
          renderQuestion();
        }
      });

      // زر إنهاء
      submitBtn.addEventListener('click', finishQuiz);

      // زر إعادة الاختبار
      restartBtn.addEventListener('click', () => {
        location.reload();
      });
    }

    /*********************************************
     *         الخطوة الرئيسية لبدء الاختبار      *
     *********************************************/
    function startQuiz() {
      // قراءة عدد الأسئلة
      const count = parseInt(questionCountInput.value) || 0;
      if (count < 1) {
        alert('يرجى إدخال عدد الأسئلة المطلوب (1 فما فوق)');
        return;
      }

      // قراءة المؤقت
      timerValue = parseInt(timerValueInput.value) || 0;

      // جمع الأسئلة من المواضيع/الفروع المختارة
      gatherQuestionsFromSelected();

      // لو لم يحدد المستخدم أي سؤال
      if (allSelectedQuestions.length === 0) {
        alert('لم يتم اختيار أي موضوع أو ملف أسئلة!');
        return;
      }

      // لو عدد الأسئلة المطلوبة أكبر من عدد الأسئلة المتاحة، نأخذ الكل
      if (count > allSelectedQuestions.length) {
        alert('عدد الأسئلة المطلوب أكبر من المتاح، سيتم أخذ جميع الأسئلة بدلاً من ذلك.');
      }

      // عشوائية الأسئلة
      if (randomizeQuestions.checked) {
        shuffleArray(allSelectedQuestions);
      }

      // اقتصاص الأسئلة بالعدد المطلوب
      const finalCount = Math.min(count, allSelectedQuestions.length);
      allSelectedQuestions = allSelectedQuestions.slice(0, finalCount);

      // تهيئة مصفوفة إجابات المستخدم
      userAnswers = new Array(allSelectedQuestions.length).fill(null);

      // إخفاء الخطوات الأولى وإظهار قسم الكويز
      document.getElementById('step-1').style.display = 'none';
      document.getElementById('step-2').style.display = 'none';
      document.getElementById('step-3').style.display = 'none';
      quizSection.style.display = 'block';

      currentQuestionIndex = 0;
      renderQuestion();

      // تشغيل المؤقّت إن وجد
      startTimerIfNeeded();
    }

    // جمع جميع الأسئلة من المواضيع/الفروع المختارة
    function gatherQuestionsFromSelected() {
      let collected = [];

      // المواضيع التي لا تحوي فروع (إن وجدت)
      // لأن بعض المواضيع في topics.json ربما لا تحوي subTopics بل ملف واحد فقط
      selectedTopics.forEach(topicIndex => {
        const topic = allTopics[topicIndex];
        // لو الموضوع نفسه فيه file بدون فروع
        if (topic.file && (!topic.subTopics || topic.subTopics.length === 0)) {
          // جمع أسئلته
          // ملاحظة: في هذا المثال، لجمع الأسئلة فوراً نستخدم await أو fetch متزامن
          // ولكن سنبسط الفكرة هنا: نفترض أننا نجمع عند الطلب. (يمكننا تعديلها إذا أردت)
          // لأغراض التبسيط سنقوم فقط بدفع مسار الملف إلى مصفوفة collected
          collected.push({ file: topic.file, sourceTitle: topic.topicName });
        }
      });

      // المواضيع الفرعية
      selectedSubtopics.forEach(code => {
        const [topicIndex, subIndex] = code.split('-').map(Number);
        const sub = allTopics[topicIndex].subTopics[subIndex];
        // أضفنا ملف الموضوع الفرعي
        collected.push({ file: sub.file, sourceTitle: sub.name });
      });

      // الآن لدينا مصفوفة من الكائنات [{file, sourceTitle}, ...]
      // يجب أن نجلب جميع الأسئلة من هذه الملفات ونجمعها في allSelectedQuestions
      // لكن تحميل الملفات يكون بشكل غير متزامن. لذا سنستخدم Promise.all
      // وسنستخدم await. بما أننا داخل سكربت عادي، سنلجأ لدالة async على السريع.
      // للحفاظ على البساطة هنا، سأستخدم أسلوب fetch متتابع (يمكن تطويره إلى Promise.all).

      allSelectedQuestions = [];
      // لإنهاء التزامن قبل البدء الفعلي:
      // سنستعمل تزامناً شبه اصطناعي هنا. في الواقع، يمكن نقل هذا الكود لـ async/await.
      // لكن لتبسيط الشرح، سنستخدم أسلوب "سلسلة وعود" متتالية (سيتطلب تقسيم الدوال).
      // في هذا المثال المصغّر، سنفترض أنَّنا نجلب الأسئلة عند الضغط على "ابدأ" (startQuiz)،
      // وبنفس الوقت (أو بشكل مسبق) قبل الرسم. ثم نكمل السلسلة.

      // سنعرّف دالة fetchQuestionsFromFile لإرجاع Promise بعد جلب الملف.
      function fetchQuestionsFromFile(path, source) {
        return fetch(path)
          .then(resp => resp.json())
          .then(json => {
            // كل عنصر في json نضيف له حقل sourceTitle اختياري
            return json.map(q => {
              q.sourceTitle = source; 
              return q;
            });
          })
          .catch(err => {
            console.error('Error loading questions from', path, err);
            return []; // إن حدث خطأ نرجع مصفوفة فارغة
          });
      }

      // الآن ننفذ سلسلة الوعود:
      let fetchChain = Promise.resolve();
      collected.forEach(item => {
        fetchChain = fetchChain.then(() => fetchQuestionsFromFile(item.file, item.sourceTitle))
          .then(questions => {
            allSelectedQuestions.push(...questions);
          });
      });

      // بعد انتهاء السلسلة بالكامل، نستدعي دالة finalizeStartQuiz
      fetchChain.then(() => {
        // الآن تم ملء allSelectedQuestions
        // لكن userAnswers وغيره لا بد أن يتم بعد إنهاء التحميل
        // هنا قد نحتاج لتأخير startQuiz إلى ما بعد انتهاء التحميل
        // كي لا يحدث تعارض. أبسط أسلوب: نفصل جلب البيانات عن startQuiz
        // أو نجعل startQuiz async. للتبسيط سنقوم بفصل جزء التهيئة.
        finalizeStartQuiz();
      });
    }

    // هذه الدالة ستُستدعى بعد جلب جميع الأسئلة
    function finalizeStartQuiz() {
      // نتحقق إن تم استدعاءها مرة ثانية بالخطأ
      if (allSelectedQuestions.length === 0) {
        alert('لم يتم العثور على أي أسئلة في الملفات المختارة!');
        return;
      }

      // بما أن startQuiz() يستدعي gatherQuestionsFromSelected()،
      // سننقل الأسطر الأخيرة من startQuiz إلى هنا:
      const count = parseInt(questionCountInput.value) || 0;
      if (count > allSelectedQuestions.length) {
        alert('عدد الأسئلة المطلوب أكبر من المتاح، سيتم أخذ جميع الأسئلة بدلاً من ذلك.');
      }
      if (randomizeQuestions.checked) {
        shuffleArray(allSelectedQuestions);
      }
      const finalCount = Math.min(count, allSelectedQuestions.length);
      allSelectedQuestions = allSelectedQuestions.slice(0, finalCount);

      userAnswers = new Array(allSelectedQuestions.length).fill(null);
      currentQuestionIndex = 0;

      // إخفاء الخطوات الأولى
      document.getElementById('step-1').style.display = 'none';
      document.getElementById('step-2').style.display = 'none';
      document.getElementById('step-3').style.display = 'none';

      // إظهار قسم الكويز
      quizSection.style.display = 'block';
      renderQuestion();
      startTimerIfNeeded();
    }

    /*********************************************
     *              عرض الأسئلة والإجابات        *
     *********************************************/
    function renderQuestion() {
      // تنظيف المؤقت للسؤال السابق (إن كنا في per-question)
      if (timerType === 'per-question') {
        clearInterval(timerInterval);
        timeRemaining = timerValue;
        startPerQuestionTimer();
      }

      // إظهار/إخفاء الأزرار
      if (currentQuestionIndex === 0) {
        prevBtn.disabled = true;
      } else {
        prevBtn.disabled = false;
      }
      if (currentQuestionIndex === allSelectedQuestions.length - 1) {
        nextBtn.style.display = 'none';
        submitBtn.style.display = 'inline-block';
      } else {
        nextBtn.style.display = 'inline-block';
        submitBtn.style.display = 'none';
      }

      // عرض شريط التقدم
      const progressPercent = ((currentQuestionIndex + 1) / allSelectedQuestions.length) * 100;
      progressBarFill.style.width = progressPercent + '%';

      // تحميل السؤال الحالي
      const q = allSelectedQuestions[currentQuestionIndex];
      quizQuestionContainer.innerHTML = '';

      // عنوان السؤال
      const questionTitle = document.createElement('h3');
      questionTitle.textContent = 'السؤال ' + (currentQuestionIndex + 1) + ': ';
      // يمكننا استخدام innerHTML لدعم المعادلات
      const questionTextSpan = document.createElement('span');
      questionTextSpan.innerHTML = q.question;
      questionTitle.appendChild(questionTextSpan);
      quizQuestionContainer.appendChild(questionTitle);

      // إنشاء الخيارات (إذا كانت أسئلة اختيار من متعدد)
      if (q.options && Array.isArray(q.options)) {
        const optionsDiv = document.createElement('div');
        optionsDiv.classList.add('quiz-options');

        q.options.forEach((optionText, optionIndex) => {
          const optionDiv = document.createElement('div');
          optionDiv.classList.add('option');

          const radioInput = document.createElement('input');
          radioInput.type = 'radio';
          radioInput.name = 'question-' + currentQuestionIndex;
          radioInput.value = optionIndex;
          // لو المستخدم اختار سابقاً هذا الخيار
          if (userAnswers[currentQuestionIndex] === optionIndex) {
            radioInput.checked = true;
          }

          // عند اختيار المستخدم
          radioInput.addEventListener('change', () => {
            userAnswers[currentQuestionIndex] = optionIndex;
          });

          const labelSpan = document.createElement('span');
          labelSpan.innerHTML = optionText;

          optionDiv.appendChild(radioInput);
          optionDiv.appendChild(labelSpan);
          optionsDiv.appendChild(optionDiv);
        });
        quizQuestionContainer.appendChild(optionsDiv);
      } else {
        // إذا سؤال نصي (Flashcard style) مثلاً
        // يمكنك تخصيصه إذا أردت
        const answerInput = document.createElement('input');
        answerInput.type = 'text';
        answerInput.style.width = '100%';
        answerInput.style.padding = '10px';
        answerInput.style.fontSize = '1rem';
        if (userAnswers[currentQuestionIndex] !== null) {
          answerInput.value = userAnswers[currentQuestionIndex];
        }
        answerInput.addEventListener('input', (e) => {
          userAnswers[currentQuestionIndex] = e.target.value;
        });
        quizQuestionContainer.appendChild(answerInput);
      }

      // إعادة تصيير MathJax
      MathJax.typesetPromise([quizQuestionContainer]).catch(err => console.error(err));
    }

    /*********************************************
     *            إنهاء الاختبار وعرض النتيجة     *
     *********************************************/
    function finishQuiz() {
      // إيقاف المؤقت إن وجد
      clearInterval(timerInterval);

      // إخفاء قسم الاختبار
      quizSection.style.display = 'none';

      // حساب النتيجة
      let correctCount = 0;
      let unanswered = 0;
      // في حال كانت MCQ (لو options موجودة)، نفترض وجود index للصواب: q.answer
      allSelectedQuestions.forEach((q, index) => {
        if (q.options && Array.isArray(q.options)) {
          if (userAnswers[index] === null) {
            unanswered++;
          } else if (userAnswers[index] === q.answer) {
            correctCount++;
          }
        } else {
          // إذا سؤال نصي فلا يوجد correct/ wrong بشكل مباشر
          // يمكننا فقط حساب unanswered إن كانت الإجابة فارغة
          if (userAnswers[index] === null || userAnswers[index].trim() === '') {
            unanswered++;
          }
        }
      });
      const total = allSelectedQuestions.length;
      const wrongCount = total - correctCount - unanswered;

      // عرض النتيجة
      resultDetails.innerHTML = `
        <p>مجموع الأسئلة: ${total}</p>
        ${
          (allSelectedQuestions[0].options && Array.isArray(allSelectedQuestions[0].options))
          ? `
          <p>إجابات صحيحة: ${correctCount}</p>
          <p>إجابات خاطئة: ${wrongCount}</p>
          <p>غير مُجاب عليها: ${unanswered}</p>
          <p>درجتك النهائية: ${(correctCount / total * 100).toFixed(2)}%</p>
          `
          : `<p>عدد الأسئلة التي لم تُجب عليها: ${unanswered}</p>`
        }
      `;

      resultSection.style.display = 'block';
    }

    /*********************************************
     *                المؤقت (Timer)             *
     *********************************************/
    function startTimerIfNeeded() {
      if (timerType === 'none') {
        timerContainer.textContent = '';
        return;
      }
      if (timerValue <= 0) {
        alert('قيمة المؤقت غير صالحة أو لم يتم إدخالها، سيتم إهمال المؤقت.');
        timerContainer.textContent = '';
        return;
      }

      if (timerType === 'total') {
        timeRemaining = timerValue;
        updateTimerDisplay();
        timerInterval = setInterval(() => {
          timeRemaining--;
          updateTimerDisplay();
          if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            finishQuiz();
          }
        }, 1000);
      } else if (timerType === 'per-question') {
        timeRemaining = timerValue;
        startPerQuestionTimer();
      }
    }

    function startPerQuestionTimer() {
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();
        if (timeRemaining <= 0) {
          clearInterval(timerInterval);
          // اعتبر هذا السؤال غير مجاب وانتقل للسؤال التالي
          userAnswers[currentQuestionIndex] = null;
          if (currentQuestionIndex < allSelectedQuestions.length - 1) {
            currentQuestionIndex++;
            renderQuestion();
          } else {
            finishQuiz();
          }
        }
      }, 1000);
    }

    function updateTimerDisplay() {
      if (timeRemaining < 0) timeRemaining = 0;
      timerContainer.textContent = 'الوقت المتبقي: ' + timeRemaining + ' ثانية';
    }

    /*********************************************
     *            دوال مساعدة عامة (Utility)     *
     *********************************************/
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }
  </script>
</body>
</html>
